<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Add Property ‚Äì Easy‚ÄØRent</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      /* --- Styles ŸÖÿÆÿ™ÿµÿ±ÿ© --- */
      :root {
        --primary: #82c9ff;
        --secondary: #6c757d;
        --light-gray: #f8f9fa;
        --success: #20115b;
      }
      * {
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      body {
        margin: 0;
        display: flex;
        background: #f0f4f8;
        color: #1a1a1a;
      }
      .sidebar {
        width: 220px;
        background: #f0eded;
        padding: 20px;
        min-height: 100vh;
      }
      .logo-container {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #b8bcbe;
      }
      .logo {
        color: var(--success);
        font-size: 28px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .sidebar a {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 10px 0;
        color: #fff;
        text-decoration: none;
        background: #89c8f8;
        border-radius: 5px;
        gap: 10px;
        transition: 0.3s;
      }
      .sidebar a:hover {
        background: #69b9f6;
      }
      .main {
        flex: 1;
        padding: 30px;
      }
      .header {
        background: #260f45;
        color: #fff;
        padding: 10px 20px;
        margin: -30px -30px 30px;
        border-radius: 0 0 8px 8px;
      }
      .form-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .form-section {
        background: #fff;
        padding: 20px;
        flex: 1;
        min-width: 500px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .form-section h3 {
        margin-bottom: 10px;
        color: #121415;
        font-size: 24px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #b0bec5;
        border-radius: 5px;
      }
      .row {
        display: flex;
        gap: 10px;
      }
      .submit-btn {
        display: block;
        padding: 12px 20px;
        margin-top: 20px;
        background: #67b7f4;
        border: none;
        border-radius: 6px;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
      }
      .submit-btn:hover {
        background: #279bf4;
      }
      #dropZone {
        display: flex;
        align-items: center;
        gap: 6px;
        border: 2px dashed #b0bec5;
        padding: 20px;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 10px;
        transition: 0.3s;
      }
      #dropZone.drag-over {
        background: #e0f0ff;
        border-color: #3baaff;
      }
      #uploadButton {
        padding: 8px 16px;
        background: #3baaff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #uploadButton:hover {
        background: #2196f3;
      }
      #previewContainer {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
      }
      .preview-wrapper {
        position: relative;
        width: 120px;
        height: 120px;
        overflow: hidden;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      .preview-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .preview-delete {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 24px;
        height: 24px;
        background: red;
        color: #fff;
        border: none;
        border-radius: 50%;
        cursor: pointer;
      }
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }
      .toast {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        margin-top: 10px;
        border-radius: 6px;
        color: #fff;
        opacity: 0;
        transform: translateX(100%);
        transition: 0.3s;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      .toast.success {
        background: #28a745;
      }
      .toast.error {
        background: #dc3545;
      }
      .toast .close-btn {
        margin-left: auto;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="logo-container">
        <h1 class="logo"><i class="fas fa-house-chimney"></i>Easy Rent</h1>
      </div>
      <a href="dashbord.html"><i class="fas fa-chart-line"></i> Dashboard</a>
      <a href="createrooms.html"><i class="fas fa-plus"></i> Add Property</a>
      <a href="myproparty.html"
        ><i class="fas fa-building"></i> My Properties</a
      >
      <a href="inbox.html"><i class="fas fa-envelope"></i> Inbox</a>
      <a href="setting.html"><i class="fas fa-user"></i> Profile Settings</a>
      <a href="../index.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
    <div class="main">
      <div class="header">
        <strong>üèó Easy Rent: Evolution in Progress!</strong>
      </div>
      <form id="propertyForm" class="form-container">
        <div class="form-section">
          <h3>Property Info</h3>
          <hr />
          <div class="row">
            <div class="form-group">
              <label>Price *</label
              ><input
                type="number"
                id="price"
                placeholder="Enter Price"
                required
              />
            </div>
            <div class="form-group">
              <label>Type *</label
              ><select required>
                <option value="">Choose Type</option>
                <option>Rent Month</option>
                <option>Rent Year</option>
                <option>Rent Day</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="form-group">
              <label>Property Name *</label
              ><input type="text" id="title" required />
            </div>
            <div class="form-group">
              <label>Home Type *</label><input type="text" required />
            </div>
          </div>
          <div class="form-group">
            <label>Address *</label
            ><textarea id="address" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label>Property Size *</label><input type="text" required />
          </div>
          <div class="row">
            <div class="form-group">
              <label>Bedrooms</label><input type="number" placeholder="No." />
            </div>
            <div class="form-group">
              <label>Bathrooms</label><input type="number" placeholder="No." />
            </div>
            <div class="form-group">
              <label>Kitchens</label><input type="number" placeholder="No." />
            </div>
          </div>
          <div class="form-group">
            <label>Additional Features</label
            ><input type="text" placeholder="Search and select features" />
          </div>
          <div class="row">
            <div class="form-group">
              <label>Country *</label><input type="text" required />
            </div>
            <div class="form-group">
              <label>State *</label><input type="text" required />
            </div>
          </div>
          <div class="row">
            <div class="form-group">
              <label>City *</label><input type="text" required />
            </div>
            <div class="form-group">
              <label>Zip/Postal Code *</label><input type="text" required />
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3>Property Image & Contact</h3>
          <hr />
          <div class="form-group">
            <label for="nearbyLandmarks">Nearby Landmarks *</label
            ><input id="nearbyLandmarks" type="text" required />
          </div>
          <div id="dropZone">
            <i class="fas fa-cloud-upload-alt"></i><span>Upload Images</span
            ><button type="button" id="uploadButton">Upload</button>
          </div>
          <input
            type="file"
            id="imageUpload"
            accept="image/png, image/jpeg"
            multiple
            style="display: none"
          />
          <div id="previewContainer"></div>
          <button type="button" id="deleteAllBtn">Delete All Images</button>
          <div class="form-group">
            <label>Contact No. *</label
            ><input type="tel" placeholder="+20..." required />
          </div>
          <div class="form-group">
            <label>WhatsApp No.</label><input type="tel" />
          </div>
          <div class="form-group">
            <label>Email *</label><input type="email" required />
          </div>
          <button type="submit" class="submit-btn">Submit</button>
        </div>
      </form>
      <div class="toast-container" id="toast-container"></div>
    </div>
    <script>
      // Helper to convert base64 to Blob
      function dataURLtoBlob(dataURL) {
        const [h, b] = dataURL.split(",");
        const mime = h.match(/:(.*?);/)[1];
        const bin = atob(b);
        const u8 = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
        return new Blob([u8], { type: mime });
      }

      // Upload photos after creating a unit
      async function uploadPhotos(unitId, photoUrls, token) {
        if (!photoUrls?.length)
          return showToast("‚úÖ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ± ŸÑŸÑÿ±ŸÅÿπ", "success");

        const fd = new FormData();
        photoUrls.forEach((src, i) => {
          fd.append("photos", dataURLtoBlob(src), `photo${i}.jpg`);
        });

        const res = await fetch(
          `https://easyrentapi0.runasp.net/api/Unit/${unitId}/upload-photos`,
          {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: fd, // **Do not set Content-Type manually**
          }
        );
        if (res.ok) showToast("‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ± ÿ®ŸÜÿ¨ÿßÿ≠!", "success");
        else {
          const err = await res.json().catch(() => null);
          showToast(
            "‚ùå ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±: " + (err?.message || res.status),
            "error"
          );
        }
      }

      // On form submit: create unit ‚Üí then upload photos
      document
        .getElementById("propertyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const token = localStorage.getItem("token");
          const ownerId = localStorage.getItem("ownerId");
          if (!token || !ownerId)
            return showToast("‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã.", "error");

          const photoUrls = JSON.parse(
            localStorage.getItem("propertyImages") || "[]"
          );
          const body = {
            title: document.getElementById("title").value.trim(),
            priceForMonth: parseFloat(document.getElementById("price").value),
            photoUrls,
            address: document.getElementById("address").value.trim(),
            status: "Available",
            ownerName: localStorage.getItem("userName") || "unknown",
            ownerId_FK: parseInt(ownerId, 10),
          };

          try {
            const res = await fetch(
              "https://easyrentapi0.runasp.net/api/Unit",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
              }
            );
            const json = await res.json().catch(() => null);
            if (!res.ok)
              return showToast(
                "‚ùå ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸàÿ≠ÿØÿ©: " + (json?.message || res.status),
                "error"
              );

            const unitId = json.id;
            showToast("‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸàÿ≠ÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠", "success");

            await uploadPhotos(unitId, photoUrls, token);

            e.target.reset();
            document.getElementById("previewContainer").innerHTML = "";
            localStorage.removeItem("propertyImages");
          } catch {
            showToast("‚ùå ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸàÿ≠ÿØÿ©.", "error");
          }
        });
    </script>
  </body>
</html>
